### Meshes 认领与收益 RULES（最终版）

- 目标与范围
  - 本规则定义 Meshes 协议的网格认领、日度挖矿发放、提现与未提现自动处理，以及相关治理与安全约束。
  - 规则为协议层逻辑约束，参数如常数 K、热度饱和值 H_max^cap 等由治理多签设定与调整。

### 基本定义

- 时间轴
  - 创世时间：`genesisTs`
  - 日索引：\( d=\left\lfloor\dfrac{t-genesisTs}{86400}\right\rfloor \)
  - 年索引：\( y=\left\lfloor\dfrac{t-genesisTs}{365\times86400}\right\rfloor \)

- 精度
  - 固定精度缩放基数：\( 10^{10} \)（用于日因子），热度与权重采用 18 位定点精度。
  - 四舍五入与下取整：未注明处默认“按整数下取整”，以保证可预测性与安全。

### 网格 ID（经纬度编码，对齐前端 /web）

- 经纬度取两位小数（单位：度），采用“四舍五入到最近两位小数”的量化规则。
- 取值域：纬度 \([-90.00,\,90.00]\)，经度 \([-180.00,\,180.00)\)。
- 编码格式（与 web 前端一致）：`^[EW][0-9]+[NS][0-9]+$`
  - 取两位小数后再乘以 100 转整型：经度部分取值范围 `[0, 17999]`，纬度部分 `[0, 9000]`；
  - 方向字母：`E` 东经、`W` 西经、`N` 北纬、`S` 南纬；
  - 示例：`E12147N3123` 对应经度 121.47、纬度 31.23；`W7423S3456` 对应经度 -74.23、纬度 -34.56。
- 面积：0.01° × 0.01°，赤道附近约 1.1km × 1.1km ≈ 1km²；随纬度按 \(\cos(\text{lat})\) 缩小（向两极逐步缩小）。

### 网格认领（Claim）

- 限制：每个“网格-用户”对仅可认领 1 次；同一网格可被无限多用户认领；同一用户可认领无限多个不同网格。
- 全局第 \( n \) 次（从 0 起）对某网格的认领热度：
  - 底数 \( b=1.2 \)，基准 \( H_0=1.0 \)（18 位定点）
  - \( Heat(n)=\min\!\big(H_0\cdot b^{n},\ H_{\max}^{cap}\big) \)
  - 采用定点安全幂与“饱和上限” \( H_{\max}^{cap} \) 防止溢出与 DoS。
- 认领燃烧费用（前端预换，合约不调用 DEX）：
  - 设归一化常数 \( K>0 \)，全网当前最大发电热度 \( H_{\max} \)
  - \( Cost_n=\left\lfloor K\cdot\dfrac{Heat(n)^2}{\max(H_{\max},1)}\right\rfloor \)
- 用户累计权重：认领成功一次，\( \Delta W_u = Heat(n) \)，累计 \( W_u\leftarrow W_u+\Delta W_u \)。

### 日度挖矿发放（无总量上限）

- 初始日因子：\( F_0=10^{10} \)
- 年度 10% 衰减（阶梯式，按年索引）：\( F(d)=F_0\cdot(0.9)^{y(d)} \)，其中 \( y(d)=\left\lfloor\dfrac{d}{365}\right\rfloor \)
- 当日应得（若当日提现）：\( R_d=\left\lfloor\dfrac{F(d)\cdot W_u}{10^{10}}\right\rfloor \)

### 提现与未提现的每日自动处理

- 记 \( B_d \) 为“日终处理前”的累计未提现余额（含历史滚存与当日未提现新增）。
- 若“当日提现成功”：
  - 实得：\( Payout_d = B_d + R_d \)
  - 次日余额：\( B_{d+1}=0 \)
- 若“当日未提现”：
  - 当日新增：\( A_d=R_d \)
  - 日终先合并：\( X_d=B_d+A_d \)
  - 应用“日衰减 50%”（40% 焚毁 + 10% 基金会 + 50% 留存）：
    - \( B_{d+1}=\left\lfloor \dfrac{X_d}{2} \right\rfloor \)
    - \( Burn_d=\left\lfloor 0.4\cdot X_d \right\rfloor \)
    - \( Fund_d=\left\lfloor 0.1\cdot X_d \right\rfloor \)
  - 恒等关系：\( X_d = B_{d+1} + Burn_d + Fund_d \)（下取整导致的个位误差累积由统计池消化）。
- 基金会代币采用“池化累计”，按小时（或更短周期）批量从合约转入 `FoundationAddr`；焚毁部分通过 `_burn` 立即或批量处理。

### 事件与指标（建议集）

- 认领：`ClaimMint(user, meshID, ts)`，`DegreeHeats(meshID, heat, count)`
- 提现：`UserMint(user, amount)`；日度统计：`dayMintAmount[d]`；用户累计：`userTotalMint[user]`
- 基金会与焚毁：`FoundationPayout(amount, ts)`；仪表板披露累计焚毁与基金会余额

### 治理与安全

- 多签操作：`setFoundationAddress`、`setBurnSwitch`、`pause`、`unpause` 等关键操作均需多签校验（含 `spendNonce` 单调递增）。
- 安全机制：`nonReentrant` 重入保护、`pausable` 紧急开关；前端预换，减少外部依赖面。
- 参数治理：\( K \)、\( H_{\max}^{cap} \)、基金会批量转账周期、打卡/活动权重系数等由多签治理设定。

### 一致性与合理性说明

- 内部一致性
  - 奖励与成本均以用户累计权重 \( W_u \) 与网格热度 \( Heat(n) \) 为核心量，计算路径单调且可预测；
  - 年度 10% 衰减确保长期通胀可控，无总量上限与生态成长兼容；
  - “日衰减 50%”将未提现的价值拆分为 40% 焚毁 + 10% 基金会 + 50% 滚存，避免无限囤积且形成生态资金来源；
  - 认领成本随全局次数指数级上升，结合 \( H_{\max} \) 归一化与 \( H_{\max}^{cap} \) 饱和，具备自然限流与数值安全。

- 公平性与用户体验
  - 规则简单：每日一次提现即拿全额当日 + 历史滚存，错过则自动“蒸发一半并计入生态”；
  - 对新用户友好：可从低热度区域开始；对热点区域则由费用调节供需；
  - 对生态友好：焚毁抑制通胀，基金会用于建设与激励，滚存保留用户合理的追溯权益。

- 可实现性与数值安全
  - 定点数与安全幂实现，\( H_{\max}^{cap} \) 防溢出，必要时对 n 采用分段/查表近似；
  - 计算路径 O(1)（提现按累计权重与累积余额结算），适配高并发；
  - 聚合转账与批量处理降低 Gas 与外部依赖风险。

### 附：位置打卡与活动（可选增强）

- 位置打卡：指定网格/POI 打卡给予一次性奖励或权重加成 \( \Delta W_u^{loc} \)，采用防作弊校验；
- 寻宝激励：官方投放“藏宝网格/谜题”，首批完成者获得奖励或加权；
- 第三方内容：小游戏、任务制、组队赛，与权重或空投联动，鼓励 UGC 与区域扩散。


